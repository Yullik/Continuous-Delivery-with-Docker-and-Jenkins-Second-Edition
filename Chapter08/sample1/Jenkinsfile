pipeline {
    agent { label 'docker-agent' } 
    environment {
        GRADLEW_PATH = "./gradlew"  
        BUILD_TIMESTAMP = "${env.BUILD_ID}"
        WORKSPACE_JAVA = "./Chapter08/sample1/"
        DOCKER_CREDENTIALS_ID = 'dockerhub-creds'  
    }
    triggers {
        pollSCM('* * * * *') 
    }
    stages {
        stage('Checkout') {
            steps {
                git branch: 'master', url: 'https://github.com/Yullik/Continuous-Delivery-with-Docker-and-Jenkins-Second-Edition.git'
            }
        }

        stage('Prepare Gradle Wrapper') {
            steps {
                dir("${WORKSPACE_JAVA}"){
                sh "chmod +x ${GRADLEW_PATH}"  
                }
            }
        }

        stage('Build') {
            steps {
                    dir("${WORKSPACE_JAVA}") {  
                    sh "${GRADLEW_PATH} build"  
                }
            }
        }

        stage('Unit test') {
            steps {
                    dir("${WORKSPACE_JAVA}") {  
                    sh "${GRADLEW_PATH} test" 
                }
            }
        }

        stage('Code coverage') {
            when {
                changeset '**/*.java' 
            }
            steps {
                    dir("${WORKSPACE_JAVA}") {  
                    sh "${GRADLEW_PATH} jacocoTestReport"  
                    sh "${GRADLEW_PATH} jacocoTestCoverageVerification" 
                }
            }
        }

        stage('Static code analysis') {
            when {
                changeset '**/*.java'  
            }
            steps {
                    dir("${WORKSPACE_JAVA}") {  
                    sh "${GRADLEW_PATH} checkstyleMain" 
                }
            }
        }

        stage('Jacoco Checkstyle Test') {
            when {
                changeset '**/*.java'  
            }
            steps {
                    dir("${WORKSPACE_JAVA}") {  
                    sh "${GRADLEW_PATH} checkstyleTest"  
                    publishHTML(target: [
                        reportDir: 'build/reports/checkstyle',  
                        reportFiles: 'main.html',  
                        reportName: "Jacoco Checkstyle"
                    ])  
                }
            }
        }

        stage('Package') {
            steps {
                    dir("${WORKSPACE_JAVA}") {  
                    sh "${GRADLEW_PATH} build"
                 }
            }
        }

        stage('Docker build') {
            steps {
                    dir("${WORKSPACE_JAVA}") { 
                    sh "docker build -t yullik/calculator:${BUILD_TIMESTAMP} ." 
                }
            }
        }

        stage('Docker login') {
            steps {
                withCredentials([usernamePassword(credentialsId: DOCKER_CREDENTIALS_ID, usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
                    sh 'docker login --username $DOCKER_USERNAME --password $DOCKER_PASSWORD'  
                }
            }
        }

        stage('Docker push') {
            steps {
                sh "docker push yullik/calculator:${BUILD_TIMESTAMP}" 
            }
        }

        stage('Update version') {
            steps {
                dir("${WORKSPACE_JAVA}") {  
                    sh "sed -i 's/{{VERSION}}/${BUILD_TIMESTAMP}/g' calculator.yaml" 
                }
            }
        }
        stage('Kubectl Config Setup') {
            steps {
                sh 'kubectl version --client'   
            }
        }
        stage('Deploy to staging') {
            steps {
                sh "kubectl config use-context staging"  
                sh "kubectl apply -f hazelcast.yaml"  
                sh "kubectl apply -f calculator.yaml"  
            }
        }

        stage('Acceptance test') {
            steps {
                sleep 60  // Wait for deployments
                sh "chmod +x acceptance-test.sh && ./acceptance-test.sh"  
            }
        }

        stage('Release') {
            steps {
                sh "kubectl config use-context production" 
                sh "kubectl apply -f hazelcast.yaml" 
                sh "kubectl apply -f calculator.yaml"  
            }
        }

        stage('Smoke test') {
            steps {
                sleep 60  // Wait for deployments
                sh "chmod +x smoke-test.sh && ./smoke-test.sh"  
            }
        }
    }
        post {
        success {
            echo "pipeline ran perfectly"
        }
        failure {
            echo "pipeline failure"
        }
    }
}
