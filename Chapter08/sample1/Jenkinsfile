pipeline {
    agent { label 'docker-agent' }

    environment {
        GRADLEW_PATH = "./gradlew"
        BUILD_TIMESTAMP = "${env.BUILD_ID}"
        WORKSPACE_JAVA = "./Chapter08/sample1/"
        DOCKER_CREDENTIALS_ID = 'dockerhub-creds'
        DOCKER_REGISTRY = 'docker.io'
    }

    triggers {
        pollSCM('H * * * *')
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/Yullik/Continuous-Delivery-with-Docker-and-Jenkins-Second-Edition.git'
            }
        }

        stage('Prepare Gradle Wrapper') {
            steps {
                dir("${WORKSPACE_JAVA}") {
                    sh "chmod +x ${GRADLEW_PATH}"
                }
            }
        }

        stage('Build') {
            steps {
                dir("${WORKSPACE_JAVA}") {
                    sh "${GRADLEW_PATH} build --no-daemon"
                }
            }
        }

        stage('Unit test') {
            when {
                not { branch 'main' }
            }
            steps {
                dir("${WORKSPACE_JAVA}") {
                    sh "${GRADLEW_PATH} test --no-daemon"
                }
            }
        }

        stage('Code coverage') {
            when {
                branch 'main'
            }
            steps {
                dir("${WORKSPACE_JAVA}") {
                    sh "${GRADLEW_PATH} jacocoTestReport --no-daemon"
                    sh "${GRADLEW_PATH} jacocoTestCoverageVerification --no-daemon"
                }
            }
        }

        stage('Static code analysis') {
            when {
                not { branch 'main' }
            }
            steps {
                dir("${WORKSPACE_JAVA}") {
                    sh "${GRADLEW_PATH} checkstyleMain --no-daemon"
                }
            }
        }

        stage('Jacoco Checkstyle Test') {
            when {
                not { branch 'main' }
            }
            steps {
                dir("${WORKSPACE_JAVA}") {
                    sh "${GRADLEW_PATH} checkstyleTest --no-daemon"
                    publishHTML(target: [
                        reportDir: 'build/reports/checkstyle',
                        reportFiles: 'main.html',
                        reportName: "Jacoco Checkstyle"
                    ])
                }
            }
        }

        stage('Package') {
            steps {
                dir("${WORKSPACE_JAVA}") {
                    sh "${GRADLEW_PATH} build --no-daemon"
                }
            }
        }

        stage('Docker Build and Push') {
            when {
                allOf {
                    expression { return currentBuild.currentResult == 'SUCCESS' }
                    not { branch 'playground' }
                    not { branch 'main' }
                    not { changeRequest() }
                }
            }
            steps {
                script {
                    def branchName = env.BRANCH_NAME
                    def imageName = ''
                    def imageVersion = ''

                    if (branchName == 'release') {
                        imageName = 'calculator'
                        imageVersion = '1.0'
                    } else if (branchName.startsWith('feature')) {
                        imageName = 'calculator-feature'
                        imageVersion = '0.1'
                    } else {
                        error "Branch '${branchName}' is not supported for image creation."
                    }

                    def fullImageName = "localhost:5000/${imageName}:${imageVersion}"
                    echo "Building and pushing Docker image: ${fullImageName}"

                    // Fix: change context to where Dockerfile actually is
                    dir("${WORKSPACE_JAVA}") {
                        def image = docker.build(fullImageName)

                        docker.withRegistry('http://localhost:5000') {
                            image.push()
                        }
                    }
                }
            }
        }
    }

    post {
        success {
            echo "pipeline ran perfectly"
        }
        failure {
            echo "pipeline failure"
        }
    }
}


