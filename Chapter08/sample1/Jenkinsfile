pipeline {
    agent any
    triggers {
        pollSCM('* * * * *') // Polling every minute
    }
    environment {
        GRADLEW_PATH = "./gradlew"  // Gradle wrapper path
        BUILD_TIMESTAMP = "${env.BUILD_ID}"  // Use Jenkins build ID as timestamp
    }
    stages {
        stage("Checkout") {
            steps {
                git branch: 'master', url: 'https://github.com/Yullik/Continuous-Delivery-with-Docker-and-Jenkins-Second-Edition.git'
            }
        }
        stage("Prepare Gradle Wrapper") {
            steps {
                dir('Chapter08/sample1') {  // Ensure we're in the correct directory
                    sh "chmod +x ${GRADLEW_PATH}"  // Make gradlew executable
                }
            }
        }
        stage("Compile") {
            steps {
                dir('Chapter08/sample1') {  // Make sure to run Gradle commands from the correct directory
                    sh "${GRADLEW_PATH} compileJava"  // Compile the Java project
                }
            }
        }
        stage("Unit test") {
            steps {
                dir('Chapter08/sample1') {  // Run unit tests in the correct directory
                    sh "${GRADLEW_PATH} test"  // Run unit tests
                }
            }
        }
        stage("Code coverage") {
            when {
                changeset "**/*.java"  // Only run this if a Java file is changed
            }
            steps {
                dir('Chapter08/sample1') {  // Run code coverage in the correct directory
                    sh "${GRADLEW_PATH} jacocoTestReport"  // Generate JaCoCo test report
                    sh "${GRADLEW_PATH} jacocoTestCoverageVerification"  // Verify coverage
                }
            }
        }
        stage("Static code analysis") {
            steps {
                dir('Chapter08/sample1') {  // Run static code analysis in the correct directory
                    sh "${GRADLEW_PATH} checkstyleMain"  // Run static code analysis with Checkstyle
                }
            }
        }
        stage("Jacoco Checkstyle Test") {
            when {
                changeset "**/*.java"  // Only run this if a Java file is changed
            }
            steps {
                dir('Chapter08/sample1') {  // Run Checkstyle on test files in the correct directory
                    sh "${GRADLEW_PATH} checkstyleTest"  // Run Checkstyle on test files
                    publishHTML(target: [
                        reportDir: 'build/reports/checkstyle',  
                        reportFiles: 'main.html',  
                        reportName: "Jacoco Checkstyle"
                    ])  // Publish Checkstyle report
                }
            }
        }
        stage("Package") {
            steps {
                dir('Chapter08/sample1') {  // Run packaging in the correct directory
                    sh "${GRADLEW_PATH} build"  // Build the project
                }
            }
        }
        stage("Docker build") {
            steps {
                dir('Chapter08/sample1') {  // Ensure Docker build is executed in the correct directory
                    sh "docker build -t leszko/calculator:${BUILD_TIMESTAMP} ."  // Build Docker image
                }
            }
        }
        stage("Docker login") {
            steps {
                withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'docker-hub-credentials',
                               usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']]) {
                    dir('Chapter08/sample1') {  // Ensure Docker login is executed in the correct directory
                        sh "docker login --username $USERNAME --password $PASSWORD"  // Docker login
                    }
                }
            }
        }
        stage("Docker push") {
            steps {
                dir('Chapter08/sample1') {  // Ensure Docker push is executed in the correct directory
                    sh "docker push leszko/calculator:${BUILD_TIMESTAMP}"  // Push Docker image to registry
                }
            }
        }
        stage("Update version") {
            steps {
                dir('Chapter08/sample1') {  // Ensure version update is executed in the correct directory
                    sh "sed -i 's/{{VERSION}}/${BUILD_TIMESTAMP}/g' calculator.yaml"  // Update version in calculator.yaml
                }
            }
        }
        stage("Deploy to staging") {
            steps {
                dir('Chapter08/sample1') {  // Ensure deploy is executed in the correct directory
                    sh "kubectl config use-context staging"  // Use Kubernetes staging context
                    sh "kubectl apply -f hazelcast.yaml"  // Deploy Hazlecast
                    sh "kubectl apply -f calculator.yaml"  // Deploy Calculator
                }
            }
        }
        stage("Acceptance test") {
            steps {
                dir('Chapter08/sample1') {  // Ensure acceptance tests are executed in the correct directory
                    sleep 60  // Wait for deployments
                    sh "chmod +x acceptance-test.sh && ./acceptance-test.sh"  // Run acceptance tests
                }
            }
        }
        stage("Release") {
            steps {
                dir('Chapter08/sample1') {  // Ensure release is executed in the correct directory
                    sh "kubectl config use-context production"  // Use Kubernetes production context
                    sh "kubectl apply -f hazelcast.yaml"  // Deploy Hazlecast to production
                    sh "kubectl apply -f calculator.yaml"  // Deploy Calculator to production
                }
            }
        }
        stage("Smoke test") {
            steps {
                dir('Chapter08/sample1') {  // Ensure smoke tests are executed in the correct directory
                    sleep 60  // Wait for deployments
                    sh "chmod +x smoke-test.sh && ./smoke-test.sh"  // Run smoke tests
                }
            }
        }
    }
    post {
        success {
            echo "Pipeline ran perfectly"
        }
        failure {
            echo "Pipeline failure"
        }
    }
}


